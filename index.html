<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PMO | OkVendas</title>

<!-- Fontes e libs -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --bg:#f1f5f9;
  --panel:#ffffff;
  --blue:#0ea5e9;
  --green:#10b981;
  --yellow:#f59e0b;
  --red:#ef4444;
  --purple:#8b5cf6;
  --text:#334155;
  --muted:#94a3b8;
  --border:#e5e7eb;
  --shadow:0 10px 30px rgba(0,0,0,.05);
  
  --color-abraao: #FFB800;
  --color-dalto: #f97316;
  --color-jonathas: #38bdf8;
  --color-lucas: #0369a1;
  --color-efraim: #0d9488;
  --color-cristhian: #475569;
  --color-ernane: #1e3a8a;
  --color-william: #16a34a;
  
  --status-andamento-bg: #dcfce7;
  --status-andamento-text: #166534;
  --status-paralisado-bg: #fee2e2;
  --status-paralisado-text: #991b1b;
  --status-cliente-bg: #f3e8ff;
  --status-cliente-text: #7e22ce;
  --status-planejado-bg: #e5e7eb;
  --status-planejado-text: #475569;
  --status-concluido-bg: #dbeafe;
  --status-concluido-text: #1e40af;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  background:var(--bg);
  font-family:'Inter',sans-serif;
  color:var(--text);
  padding:24px;
  overflow-x: hidden;
}

.container{max-width:1400px;margin:auto}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:28px;
  flex-wrap: wrap;
  gap: 15px;
}

header h1{
  font-size:24px;
  font-weight:800;
  color:var(--blue);
}

header span{
  font-weight:300;
  color:var(--muted);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.btn-refresh, .btn-clear-filters {
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
  box-shadow: var(--shadow);
}

.btn-refresh:hover {
  background: var(--blue);
  color: white;
  border-color: var(--blue);
}

.btn-clear-filters {
  background: var(--red);
  color: white;
  border-color: var(--red);
  display: none;
}

.btn-clear-filters:hover {
  filter: brightness(1.1);
  transform: translateY(-2px);
}

.spinning {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.active-filters {
  background: var(--panel);
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  display: none;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  border-left: 4px solid var(--blue);
}

.active-filters .filter-label {
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
}

.active-filters .filter-tag {
  background: var(--blue);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* FILTROS NOS CABE√áALHOS DA TABELA */
.filter-header {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.filter-header-label {
  font-size: 11px;
  text-transform: uppercase;
  color: var(--muted);
  font-weight: 700;
}

.header-filter-select {
  padding: 6px 10px;
  border: 2px solid var(--border);
  border-radius: 8px;
  font-size: 11px;
  font-weight: 600;
  background: white;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23334155' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 8px center;
  padding-right: 28px;
  width: 100%;
}

.header-filter-select:hover {
  border-color: var(--purple);
}

.header-filter-select:focus {
  outline: none;
  border-color: var(--purple);
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}

.header-filter-select.active {
  border-color: var(--purple);
  background-color: #f3e8ff;
}

.btn-clear-table-filters {
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  display: none;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}

.btn-clear-table-filters:hover {
  background: var(--red);
  color: white;
  border-color: var(--red);
}

.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:16px;
  margin-bottom:30px;
}

.kpi{
  background:var(--panel);
  padding:24px;
  border-radius:18px;
  box-shadow:var(--shadow);
  text-align:center;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border: 1px solid transparent;
  cursor: pointer;
  position: relative;
}

.kpi:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  border-color: var(--blue);
}

.kpi.active {
  border-color: var(--blue);
  background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
}

.kpi i{
  font-size:18px;
  margin-bottom:10px;
  color: var(--blue);
}

.kpi h3{
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:6px;
}

.kpi p{
  font-size:32px;
  font-weight:800;
}

.kpi-hint {
  font-size: 10px;
  color: var(--muted);
  margin-top: 8px;
  opacity: 0;
  transition: opacity 0.2s;
}

.kpi:hover .kpi-hint {
  opacity: 1;
}

.charts{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.chart-box{
  background:var(--panel);
  border-radius:18px;
  padding:24px;
  box-shadow:var(--shadow);
  height:380px;
  display: flex;
  flex-direction: column;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  gap: 12px;
}

.chart-title{
  font-size:13px;
  font-weight:700;
  color: var(--text);
  white-space: nowrap;
}

.chart-select {
  padding: 8px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 12px;
  font-weight: 600;
  background: white;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  min-width: 150px;
}

.chart-select:hover {
  border-color: var(--blue);
}

.chart-select:focus {
  outline: none;
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

.chart-info {
  font-size: 11px;
  color: var(--muted);
  margin-top: 8px;
  padding: 8px 12px;
  background: #f8fafc;
  border-radius: 8px;
  display: none;
}

.chart-info.show {
  display: block;
}

.chart-info strong {
  color: var(--text);
  font-weight: 600;
}

.semaforo-indicator {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-right: 6px;
}

.semaforo-verde { background-color: #10b981; }
.semaforo-amarelo { background-color: #f59e0b; }
.semaforo-vermelho { background-color: #ef4444; }

.chart-canvas-wrapper {
  flex: 1;
  position: relative;
  min-height: 0;
}

.panel {
  background: var(--panel);
  border-radius: 18px;
  padding: 24px;
  box-shadow: var(--shadow);
  margin-bottom: 30px;
}

.panel-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.panel-title i {
  color: var(--blue);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

thead {
  background: #f8fafc;
  position: sticky;
  top: 0;
  z-index: 10;
}

thead th {
  padding: 14px 16px;
  text-align: left;
  font-weight: 700;
  font-size: 11px;
  text-transform: uppercase;
  color: var(--muted);
  border-bottom: 2px solid var(--border);
  vertical-align: top;
}

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.15s;
}

tbody tr:hover {
  background: #f8fafc;
}

tbody td {
  padding: 16px;
}

.project-name {
  font-weight: 600;
  color: var(--blue);
  cursor: pointer;
  transition: color 0.2s;
}

.project-name:hover {
  color: var(--purple);
  text-decoration: underline;
}

.badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.em-andamento {
  background: var(--status-andamento-bg);
  color: var(--status-andamento-text);
}

.paralisado {
  background: var(--status-paralisado-bg);
  color: var(--status-paralisado-text);
}

.ag-cliente {
  background: var(--status-cliente-bg);
  color: var(--status-cliente-text);
}

.planejado {
  background: var(--status-planejado-bg);
  color: var(--status-planejado-text);
}

.concluido {
  background: var(--status-concluido-bg);
  color: var(--status-concluido-text);
}

.analista-bold {
  font-weight: 700;
}

.Abra√£o { color: var(--color-abraao); }
.Dalto { color: var(--color-dalto); }
.Jonathas { color: var(--color-jonathas); }
.Lucas { color: var(--color-lucas); }
.Efraim { color: var(--color-efraim); }
.Cristhian { color: var(--color-cristhian); }
.Ernane { color: var(--color-ernane); }
.William { color: var(--color-william); }

.progress {
  display: flex;
  align-items: center;
  gap: 10px;
}

.bar {
  flex: 1;
  height: 8px;
  background: #e5e7eb;
  border-radius: 10px;
  overflow: hidden;
}

.fill {
  height: 100%;
  background: linear-gradient(90deg, var(--blue), var(--purple));
  border-radius: 10px;
  transition: width 0.3s ease;
}

.no-results {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.no-results i {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.no-results h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 8px;
}

.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.2s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: white;
  padding: 32px;
  border-radius: 20px;
  max-width: 600px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border);
}

.modal-header h2 {
  font-size: 20px;
  font-weight: 800;
  color: var(--blue);
}

.close-modal {
  background: var(--border);
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  color: var(--text);
  font-size: 18px;
}

.close-modal:hover {
  background: var(--red);
  color: white;
  transform: rotate(90deg);
}

.modal-body {
  display: grid;
  gap: 16px;
}

.modal-field {
  display: grid;
  grid-template-columns: 140px 1fr;
  gap: 12px;
  align-items: start;
  padding: 12px 0;
  border-bottom: 1px solid #f1f5f9;
}

.modal-field:last-child {
  border-bottom: none;
}

.modal-label {
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
}

.modal-value {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
}

footer {
  text-align: center;
  padding: 24px;
  color: var(--muted);
  font-size: 12px;
  margin-top: 40px;
}

footer a {
  color: var(--blue);
  text-decoration: none;
  font-weight: 600;
}

footer a:hover {
  text-decoration: underline;
}

@media (max-width: 768px) {
  body {
    padding: 16px;
  }
  
  header h1 {
    font-size: 20px;
  }
  
  .kpis {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .charts {
    grid-template-columns: 1fr;
  }
  
  table {
    font-size: 11px;
  }
  
  .modal-field {
    grid-template-columns: 1fr;
    gap: 6px;
  }
  
  .table-filters-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>
<div class="container">

<header>
  <div>
    <h1>PMO | OkVendas <span>Dashboard Executivo</span></h1>
  </div>
  <div class="header-actions">
    <button class="btn-clear-filters" id="btnClearFilters" onclick="clearAllFilters()">
      <i class="fa-solid fa-filter-circle-xmark"></i>
      Limpar Filtros Gerais
    </button>
    <button class="btn-refresh" onclick="fetchData()">
      <i class="fa-solid fa-rotate" id="refreshIcon"></i>
      Atualizar
    </button>
  </div>
</header>

<div class="active-filters" id="activeFilters">
  <span class="filter-label">Filtros ativos:</span>
</div>

<div class="kpis">
  <div class="kpi" onclick="filterByStatus(null)">
    <i class="fa-solid fa-diagram-project"></i>
    <h3>Total de Projetos</h3>
    <p id="kTotal">0</p>
    <div class="kpi-hint">Clique para ver todos</div>
  </div>
  
  <div class="kpi" onclick="filterByStatus('andamento')">
    <i class="fa-solid fa-spinner"></i>
    <h3>Em Andamento</h3>
    <p id="kAtivos" style="color:var(--green)">0</p>
    <div class="kpi-hint">Clique para filtrar</div>
  </div>
  
  <div class="kpi" onclick="filterByStatus('paralisado')">
    <i class="fa-solid fa-pause"></i>
    <h3>Paralisados</h3>
    <p id="kPausados" style="color:var(--red)">0</p>
    <div class="kpi-hint">Clique para filtrar</div>
  </div>
  
  <div class="kpi" onclick="filterByStatus('cliente')">
    <i class="fa-solid fa-user-clock"></i>
    <h3>Aguardando Cliente</h3>
    <p id="kCliente" style="color:var(--purple)">0</p>
    <div class="kpi-hint">Clique para filtrar</div>
  </div>
</div>

<div class="charts">
  <div class="chart-box">
    <div class="chart-header">
      <span class="chart-title">Status dos Projetos</span>
    </div>
    <div class="chart-canvas-wrapper">
      <canvas id="status"></canvas>
    </div>
  </div>
  
  <div class="chart-box">
    <div class="chart-header">
      <span class="chart-title">Projetos por Analista</span>
      <select id="analistaSelect" class="chart-select" onchange="updateAnalistaChart()">
        <option value="all">Todos os Analistas</option>
      </select>
    </div>
    <div class="chart-canvas-wrapper">
      <canvas id="analistas"></canvas>
    </div>
  </div>
  
  <div class="chart-box">
    <div class="chart-header">
      <span class="chart-title">Curva S - Evolu√ß√£o</span>
      <select id="projectSelect" class="chart-select" onchange="updateCurvaS()">
        <option value="all">Vis√£o Geral</option>
      </select>
    </div>
    <div class="chart-canvas-wrapper">
      <canvas id="curve"></canvas>
    </div>
    <div class="chart-info" id="curvaInfo"></div>
  </div>
</div>


<div class="panel">
  <div class="panel-title">
    <i class="fa-solid fa-table"></i>
    Detalhamento de Projetos
    <button class="btn-clear-table-filters" id="btnClearTableFilters" onclick="clearTableFilters()" style="margin-left: auto;">
      <i class="fa-solid fa-filter-circle-xmark"></i>
      Limpar Filtros
    </button>
  </div>
  <table>
    <thead>
      <tr>
        <th>
          <div class="filter-header">
            <span class="filter-header-label">PROJETO</span>
            <select id="tableProjectFilter" class="header-filter-select" onchange="applyTableFilters()">
              <option value="">Todos</option>
            </select>
          </div>
        </th>
        <th>DATA PREVISTA</th>
        <th>
          <div class="filter-header">
            <span class="filter-header-label">ANALISTA</span>
            <select id="tableAnalistaFilter" class="header-filter-select" onchange="applyTableFilters()">
              <option value="">Todos</option>
            </select>
          </div>
        </th>
        <th>
          <div class="filter-header">
            <span class="filter-header-label">STATUS</span>
            <select id="tableStatusFilter" class="header-filter-select" onchange="applyTableFilters()">
              <option value="">Todos</option>
            </select>
          </div>
        </th>
        <th>EVOLU√á√ÉO</th>
        <th>INFO</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr>
        <td colspan="6">
          <div class="no-results">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
            <h3>Carregando dados...</h3>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<footer>
  Dashboard desenvolvido por <a href="#">OkVendas PMO</a> | Atualizado automaticamente a cada 5 minutos
</footer>

</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="mTitle">Detalhes do Projeto</h2>
      <button class="close-modal" onclick="closeModal()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="modal-field">
        <span class="modal-label">Analista</span>
        <span class="modal-value" id="mAnalista">-</span>
      </div>
      <div class="modal-field">
        <span class="modal-label">Status</span>
        <span class="modal-value" id="mStatus">-</span>
      </div>
      <div class="modal-field">
        <span class="modal-label">Data Prevista</span>
        <span class="modal-value" id="mData">-</span>
      </div>
      <div class="modal-field">
        <span class="modal-label">Conclu√≠das</span>
        <span class="modal-value" id="mConcluidas">-</span>
      </div>
      <div class="modal-field">
        <span class="modal-label">Em Valida√ß√£o</span>
        <span class="modal-value" id="mValidacao">-</span>
      </div>
      <div class="modal-field">
        <span class="modal-label">Lib. Produ√ß√£o</span>
        <span class="modal-value" id="mLiberacao">-</span>
      </div>
      <div class="modal-field">
        <span class="modal-label">Em Execu√ß√£o</span>
        <span class="modal-value" id="mExecucao">-</span>
      </div>
      <div class="modal-field">
        <span class="modal-label">In√≠cio</span>
        <span class="modal-value" id="mInicio">-</span>
      </div>
      <div class="modal-field">
        <span class="modal-label">Descri√ß√£o</span>
        <span class="modal-value" id="mDescricao">-</span>
      </div>
      <div class="modal-field">
        <span class="modal-label">Total Atividades</span>
        <span class="modal-value" id="mTotal">-</span>
      </div>
      <div class="modal-field">
        <span class="modal-label">Observa√ß√µes</span>
        <span class="modal-value" id="mObs">-</span>
      </div>
    </div>
  </div>
</div>

<script>
let projectData = [];
let currentFilters = { analista: null, status: null };
let tableFilters = { projeto: '', analista: '', status: '' }; // NOVO: filtros da tabela
let charts = { status: null, analistas: null, curve: null };
const DEBUG = true;

function debugLog(msg, type = 'info') {
  if (!DEBUG) return;
  const styles = {
    info: 'color: #0ea5e9; font-weight: bold',
    success: 'color: #10b981; font-weight: bold',
    warning: 'color: #f59e0b; font-weight: bold',
    error: 'color: #ef4444; font-weight: bold'
  };
  console.log(`%c[PMO] ${msg}`, styles[type] || styles.info);
}

function cleanKey(str) {
  return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function getAnalistaClass(nome) {
  const map = {
    "Abra√£o": "Abra√£o", "Dalto": "Dalto", "Jonathas": "Jonathas",
    "Lucas": "Lucas", "Efraim": "Efraim", "Cristhian": "Cristhian",
    "Ernane": "Ernane", "William": "William"
  };
  return map[nome] || "";
}

function getAnalistaColor(nome) {
  const map = {
    "Abra√£o": "#FFB800", "Dalto": "#f97316", "Jonathas": "#38bdf8",
    "Lucas": "#0369a1", "Efraim": "#0d9488", "Cristhian": "#475569",
    "Ernane": "#1e3a8a", "William": "#16a34a"
  };
  return map[nome] || "#94a3b8";
}

function getStatusColor(status) {
  const key = cleanKey(status);
  if (key.includes("andamento")) return "#10b981";
  if (key.includes("paralisado")) return "#ef4444";
  if (key.includes("cliente")) return "#8b5cf6";
  if (key.includes("planejado")) return "#94a3b8";
  if (key.includes("concluido")) return "#0ea5e9";
  return "#94a3b8";
}

function getSemaforoColor(diferenca) {
  if (diferenca <= 10) return 'verde';
  if (diferenca <= 30) return 'amarelo';
  return 'vermelho';
}

function destroyChart(chartName) {
  if (charts[chartName]) {
    debugLog(`üóëÔ∏è Destruindo gr√°fico: ${chartName}`, 'warning');
    charts[chartName].destroy();
    charts[chartName] = null;
  }
}

function destroyAllCharts() {
  debugLog('üóëÔ∏è Destruindo todos os gr√°ficos', 'warning');
  Object.keys(charts).forEach(key => destroyChart(key));
}

// ========== FETCH DATA ==========
async function fetchData() {
  const icon = document.getElementById('refreshIcon');
  icon.classList.add('spinning');
  
  debugLog('üîÑ Iniciando busca de dados...', 'info');
  
  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbwBDw-TLmRvqC8Vd7q3yxE_B6hb0i3vPWqgWZqy4U8mBVTdJC1_O7UKXDOlW3DXxKo/exec");
    const json = await response.json();
    
    if (!json.data || json.data.length === 0) {
      debugLog('‚ö†Ô∏è Nenhum dado encontrado', 'warning');
      return;
    }
    
    projectData = json.data;
    debugLog(`‚úÖ ${projectData.length} projetos carregados`, 'success');
    
    populateFilters();
    populateTableFilters(); // NOVO: popular filtros da tabela
    renderAll();
  } catch (err) {
    debugLog(`‚ùå Erro ao buscar dados: ${err.message}`, 'error');
  } finally {
    icon.classList.remove('spinning');
  }
}

// ========== POPULAR FILTROS ==========
function populateFilters() {
  const analistas = [...new Set(projectData.map(p => p.Analista))].sort();
  const projetos = [...new Set(projectData.map(p => p.Projeto))].sort();
  
  const analistaSelect = document.getElementById('analistaSelect');
  analistaSelect.innerHTML = '<option value="all">Todos os Analistas</option>' + 
    analistas.map(a => `<option value="${a}">${a}</option>`).join('');
  
  const projectSelect = document.getElementById('projectSelect');
  projectSelect.innerHTML = '<option value="all">Vis√£o Geral</option>' + 
    projetos.map(p => `<option value="${p}">${p}</option>`).join('');
  
  debugLog('‚úÖ Filtros de gr√°ficos populados', 'success');
}

// ========== NOVO: POPULAR FILTROS DA TABELA ==========
function populateTableFilters() {
  const projetos = [...new Set(projectData.map(p => p.Projeto))].sort();
  const analistas = [...new Set(projectData.map(p => p.Analista))].sort();
  const status = [...new Set(projectData.map(p => p.Status))].sort();
  
  const projectFilter = document.getElementById('tableProjectFilter');
  projectFilter.innerHTML = '<option value="">Todos os Projetos</option>' + 
    projetos.map(p => `<option value="${p}">${p}</option>`).join('');
  
  const analistaFilter = document.getElementById('tableAnalistaFilter');
  analistaFilter.innerHTML = '<option value="">Todos os Analistas</option>' + 
    analistas.map(a => `<option value="${a}">${a}</option>`).join('');
  
  const statusFilter = document.getElementById('tableStatusFilter');
  statusFilter.innerHTML = '<option value="">Todos os Status</option>' + 
    status.map(s => `<option value="${s}">${s}</option>`).join('');
  
  debugLog('‚úÖ Filtros da tabela populados', 'success');
}

// ========== NOVO: APLICAR FILTROS DA TABELA ==========
function applyTableFilters() {
  tableFilters.projeto = document.getElementById('tableProjectFilter').value;
  tableFilters.analista = document.getElementById('tableAnalistaFilter').value;
  tableFilters.status = document.getElementById('tableStatusFilter').value;
  
  debugLog(`üîç Filtros da tabela aplicados: ${JSON.stringify(tableFilters)}`, 'info');
  
  // Atualizar apar√™ncia dos selects
  updateFilterSelectsAppearance();
  
  // Mostrar/ocultar bot√£o de limpar
  const hasFilters = tableFilters.projeto || tableFilters.analista || tableFilters.status;
  document.getElementById('btnClearTableFilters').style.display = hasFilters ? 'flex' : 'none';
  
  renderTable(getTableFilteredData());
}

// ========== NOVO: ATUALIZAR APAR√äNCIA DOS SELECTS ==========
function updateFilterSelectsAppearance() {
  const projectSelect = document.getElementById('tableProjectFilter');
  const analistaSelect = document.getElementById('tableAnalistaFilter');
  const statusSelect = document.getElementById('tableStatusFilter');
  
  projectSelect.classList.toggle('active', tableFilters.projeto !== '');
  analistaSelect.classList.toggle('active', tableFilters.analista !== '');
  statusSelect.classList.toggle('active', tableFilters.status !== '');
}

// ========== NOVO: LIMPAR FILTROS DA TABELA ==========
function clearTableFilters() {
  tableFilters = { projeto: '', analista: '', status: '' };
  
  document.getElementById('tableProjectFilter').value = '';
  document.getElementById('tableAnalistaFilter').value = '';
  document.getElementById('tableStatusFilter').value = '';
  
  updateFilterSelectsAppearance();
  document.getElementById('btnClearTableFilters').style.display = 'none';
  
  renderTable(getFilteredData());
  
  debugLog('üßπ Filtros da tabela limpos', 'info');
}

// ========== NOVO: OBTER DADOS FILTRADOS DA TABELA ==========
function getTableFilteredData() {
  let filtered = getFilteredData(); // Aplica os filtros gerais primeiro
  
  if (tableFilters.projeto) {
    filtered = filtered.filter(p => p.Projeto === tableFilters.projeto);
  }
  if (tableFilters.analista) {
    filtered = filtered.filter(p => p.Analista === tableFilters.analista);
  }
  if (tableFilters.status) {
    filtered = filtered.filter(p => p.Status === tableFilters.status);
  }
  
  return filtered;
}

// ========== FILTROS GERAIS ==========
function filterByStatus(status) {
  debugLog(`üéØ Filtro de status selecionado: ${status || 'todos'}`, 'info');
  currentFilters.status = status;
  updateFiltersUI();
  renderAll();
}

function clearAllFilters() {
  debugLog('üßπ Limpando todos os filtros gerais', 'info');
  currentFilters = { analista: null, status: null };
  
  const analistaSelect = document.getElementById('analistaSelect');
  if (analistaSelect) analistaSelect.value = 'all';
  
  updateFiltersUI();
  renderAll();
}

function updateFiltersUI() {
  const activeFiltersEl = document.getElementById('activeFilters');
  const btnClear = document.getElementById('btnClearFilters');
  
  const hasFilters = currentFilters.analista || currentFilters.status;
  
  if (hasFilters) {
    const tags = [];
    if (currentFilters.analista) {
      tags.push(`<span class="filter-tag">Analista: ${currentFilters.analista}</span>`);
    }
    if (currentFilters.status) {
      const statusText = currentFilters.status === 'andamento' ? 'Em Andamento' : 
                        currentFilters.status === 'paralisado' ? 'Paralisado' : 
                        'Ag. Cliente';
      tags.push(`<span class="filter-tag">Status: ${statusText}</span>`);
    }
    activeFiltersEl.innerHTML = '<span class="filter-label">Filtros ativos:</span>' + tags.join('');
    activeFiltersEl.style.display = 'flex';
    btnClear.style.display = 'flex';
  } else {
    activeFiltersEl.style.display = 'none';
    btnClear.style.display = 'none';
  }
  
  document.querySelectorAll('.kpi').forEach(kpi => kpi.classList.remove('active'));
  const kpis = document.querySelectorAll('.kpi');
  if (currentFilters.status === 'andamento') kpis[1]?.classList.add('active');
  else if (currentFilters.status === 'paralisado') kpis[2]?.classList.add('active');
  else if (currentFilters.status === 'cliente') kpis[3]?.classList.add('active');
  else if (!currentFilters.status) kpis[0]?.classList.add('active');
}

function getFilteredData() {
  let filtered = [...projectData];
  if (currentFilters.analista) filtered = filtered.filter(p => p.Analista === currentFilters.analista);
  if (currentFilters.status) filtered = filtered.filter(p => cleanKey(p.Status).includes(currentFilters.status));
  return filtered;
}

// ========== RENDER ==========
function renderAll() {
  const filtered = getFilteredData();
  renderTable(getTableFilteredData()); // MODIFICADO: usar dados filtrados da tabela
  renderKPIs(projectData);
  renderCharts(filtered);
}

function renderTable(p) {
  const tb = document.getElementById("tbody");
  if (p.length === 0) {
    tb.innerHTML = `<tr><td colspan="6"><div class="no-results"><i class="fa-solid fa-inbox"></i><h3>Nenhum projeto encontrado</h3><p style="margin-top:8px;font-size:13px">Ajuste os filtros</p></div></td></tr>`;
    return;
  }
  
  tb.innerHTML = p.map(x => {
    const perc = x.Total > 0 ? Math.round((x.Concluidas / x.Total) * 100) : 0;
    const statusClass = cleanKey(x.Status).replace(/\./g, "").replace(/\s/g, '-');
    const analistaClass = getAnalistaClass(x.Analista);
    
    const projetoEscaped = x.Projeto.replace(/'/g, "\\'").replace(/`/g, "\\`");
    
    return `<tr>
      <td><span class="project-name" onclick="openProjectModal('${projetoEscaped}')">${x.Projeto}</span></td>
      <td>${x.DataPrevista}</td>
      <td class="analista-bold ${analistaClass}">${x.Analista}</td>
      <td><span class="badge ${statusClass}">${x.Status}</span></td>
      <td><div class="progress"><div class="bar"><div class="fill" style="width:${perc}%"></div></div><strong style="width:35px;text-align:right">${perc}%</strong></div></td>
      <td><i class="fa-solid fa-circle-info" style="cursor:pointer;color:var(--blue)" onclick="openProjectModal('${projetoEscaped}')"></i></td>
    </tr>`;
  }).join("");
}

function renderKPIs(p) {
  document.getElementById("kTotal").innerText = p.length;
  document.getElementById("kAtivos").innerText = p.filter(x => cleanKey(x.Status).includes("andamento")).length;
  document.getElementById("kPausados").innerText = p.filter(x => cleanKey(x.Status).includes("paralisado")).length;
  document.getElementById("kCliente").innerText = p.filter(x => cleanKey(x.Status).includes("cliente")).length;
}

function renderCharts(p) {
  if (p.length === 0) {
    destroyAllCharts();
    return;
  }
  
  renderStatusChart(p);
  updateAnalistaChart();
  updateCurvaS();
}

function renderStatusChart(p) {
  const statusCount = {};
  p.forEach(x => {
    statusCount[x.Status] = (statusCount[x.Status] || 0) + 1;
  });
  
  destroyChart('status');
  
  const statusLabels = Object.keys(statusCount);
  const statusColors = statusLabels.map(s => getStatusColor(s));
  
  const statusCanvas = document.getElementById('status');
  if (!statusCanvas) {
    debugLog('‚ö†Ô∏è Canvas de status n√£o encontrado', 'warning');
    return;
  }
  
  charts.status = new Chart(statusCanvas, {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{ data: Object.values(statusCount), backgroundColor: statusColors, borderWidth: 0, hoverOffset: 10 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11, weight: '600' } } },
        tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed} projeto(s)` } }
      }
    }
  });
  
  debugLog(`‚úÖ Gr√°fico de status criado com ${statusLabels.length} categorias`, 'success');
}

function updateAnalistaChart() {
  const select = document.getElementById('analistaSelect');
  const selectedAnalista = select.value;
  
  if (selectedAnalista !== 'all' && currentFilters.analista !== selectedAnalista) {
    currentFilters.analista = selectedAnalista;
    renderAll();
    return;
  }
  
  if (selectedAnalista === 'all' && currentFilters.analista) {
    currentFilters.analista = null;
    renderAll();
    return;
  }
  
  let dataToShow = getFilteredData();
  
  const analistasCount = {};
  dataToShow.forEach(x => {
    analistasCount[x.Analista] = (analistasCount[x.Analista] || 0) + 1;
  });
  
  const analistaLabels = Object.keys(analistasCount);
  const analistaColors = analistaLabels.map(n => getAnalistaColor(n));
  
  destroyChart('analistas');
  
  const analistasCanvas = document.getElementById('analistas');
  if (!analistasCanvas) {
    debugLog('‚ö†Ô∏è Canvas de analistas n√£o encontrado', 'warning');
    return;
  }
  
  charts.analistas = new Chart(analistasCanvas, {
    type: 'bar',
    data: {
      labels: analistaLabels,
      datasets: [{ data: Object.values(analistasCount), backgroundColor: analistaColors, borderRadius: 6, barThickness: 20 }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: (ctx) => `${ctx.parsed.x} projeto(s)` } }
      },
      scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
  
  debugLog(`‚úÖ Gr√°fico de analistas criado com ${analistaLabels.length} analistas`, 'success');
}

function updateCurvaS() {
  const select = document.getElementById('projectSelect');
  const selectedProject = select.value;
  const curvaInfoEl = document.getElementById('curvaInfo');
  
  let data, label, cor, diferenca;
  
  if (selectedProject === 'all') {
    const filtered = getFilteredData();
    const media = filtered.length > 0 
      ? Math.round(filtered.reduce((acc, curr) => acc + (curr.Total > 0 ? (curr.Concluidas / curr.Total) * 100 : 0), 0) / filtered.length)
      : 0;
    
    diferenca = 100 - media;
    const semaforo = getSemaforoColor(diferenca);
    cor = semaforo === 'verde' ? '#10b981' : semaforo === 'amarelo' ? '#f59e0b' : '#ef4444';
    
    data = [0, media];
    label = 'Realizado (M√©dia Geral)';
    
    curvaInfoEl.innerHTML = `<span class="semaforo-indicator semaforo-${semaforo}"></span><strong>Diferen√ßa: ${diferenca.toFixed(1)}%</strong> entre planejado e realizado`;
    curvaInfoEl.classList.add('show');
  } else {
    const projeto = projectData.find(p => p.Projeto === selectedProject);
    if (projeto) {
      const perc = projeto.Total > 0 ? Math.round((projeto.Concluidas / projeto.Total) * 100) : 0;
      diferenca = 100 - perc;
      const semaforo = getSemaforoColor(diferenca);
      cor = semaforo === 'verde' ? '#10b981' : semaforo === 'amarelo' ? '#f59e0b' : '#ef4444';
      
      data = [0, perc];
      label = `Realizado (${projeto.Projeto})`;
      
      curvaInfoEl.innerHTML = `<span class="semaforo-indicator semaforo-${semaforo}"></span><strong>Diferen√ßa: ${diferenca.toFixed(1)}%</strong> entre planejado e realizado | <strong>${projeto.Concluidas}/${projeto.Total}</strong> atividades`;
      curvaInfoEl.classList.add('show');
    } else {
      debugLog('‚ö†Ô∏è Projeto n√£o encontrado para Curva S', 'warning');
      return;
    }
  }
  
  destroyChart('curve');
  
  const curveCanvas = document.getElementById('curve');
  if (!curveCanvas) {
    debugLog('‚ö†Ô∏è Canvas de curva S n√£o encontrado', 'warning');
    return;
  }
  
  charts.curve = new Chart(curveCanvas, {
    type: 'line',
    data: {
      labels: ['In√≠cio', 'Progresso Atual'],
      datasets: [
        { label: 'Meta Planejada', data: [0, 100], borderColor: '#94a3b8', borderDash: [5, 5], borderWidth: 2, fill: false, tension: 0.4, pointRadius: 4 },
        { label: label, data: data, borderColor: cor, backgroundColor: cor + '20', fill: true, tension: 0.4, pointRadius: 5, pointHoverRadius: 7 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11, weight: '600' } } },
        tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}%` } }
      },
      scales: { y: { beginAtZero: true, max: 100, ticks: { callback: (v) => v + '%' } } }
    }
  });
  
  debugLog(`‚úÖ Curva S criada para: ${selectedProject === 'all' ? 'Vis√£o Geral' : selectedProject}`, 'success');
}

// ========== MODAL ==========
function openProjectModal(projectName) {
  const projeto = projectData.find(p => p.Projeto === projectName);
  
  if (!projeto) return;
  
  document.getElementById("mTitle").textContent = projeto.Projeto;
  document.getElementById("mAnalista").textContent = projeto.Analista;
  document.getElementById("mStatus").textContent = projeto.Status;
  document.getElementById("mData").textContent = projeto.DataPrevista;
  document.getElementById("mConcluidas").textContent = projeto.Concluidas;
  document.getElementById("mValidacao").textContent = projeto.Validacao;
  document.getElementById("mLiberacao").textContent = projeto.Liberacao;
  document.getElementById("mExecucao").textContent = projeto.Execucao;
  document.getElementById("mInicio").textContent = projeto.Inicio;
  document.getElementById("mDescricao").textContent = projeto.Descricao;
  document.getElementById("mTotal").textContent = projeto.Total;
  document.getElementById("mObs").textContent = projeto.Obs;
  
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

window.onclick = e => {
  if (e.target == document.getElementById("modal")) closeModal();
}

// ========== INIT ==========
window.onload = fetchData;
setInterval(fetchData, 300000);
window.addEventListener('beforeunload', () => {
  destroyAllCharts();
  clearAllFilters();
});
</script>
</body>
</html>
