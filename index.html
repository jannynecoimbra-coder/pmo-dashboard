<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PMO | OkVendas</title>

<!-- Fontes e libs -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  --bg:#f1f5f9;
  --panel:#ffffff;
  --blue:#0ea5e9;
  --green:#10b981;
  --yellow:#f59e0b;
  --red:#ef4444;
  --purple:#8b5cf6;
  --text:#334155;
  --muted:#94a3b8;
  --border:#e5e7eb;
  --shadow:0 10px 30px rgba(0,0,0,.05);
  
  --color-abraao: #FFB800;
  --color-dalto: #f97316;
  --color-jonathas: #38bdf8;
  --color-lucas: #0369a1;
  --color-efraim: #0d9488;
  --color-cristhian: #475569;
  --color-ernane: #1e3a8a;
  --color-william: #16a34a;
  
  --status-andamento-bg: #dcfce7;
  --status-andamento-text: #166534;
  --status-paralisado-bg: #fee2e2;
  --status-paralisado-text: #991b1b;
  --status-cliente-bg: #f3e8ff;
  --status-cliente-text: #7e22ce;
  --status-planejado-bg: #e5e7eb;
  --status-planejado-text: #475569;
  --status-concluido-bg: #dbeafe;
  --status-concluido-text: #1e40af;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  background:var(--bg);
  font-family:'Inter',sans-serif;
  color:var(--text);
  padding:24px;
  overflow-x: hidden;
}

.container{max-width:1400px;margin:auto}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:28px;
  flex-wrap: wrap;
  gap: 15px;
}

header h1{
  font-size:24px;
  font-weight:800;
  color:var(--blue);
}

header span{
  font-weight:300;
  color:var(--muted);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.btn-refresh, .btn-clear-filters {
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
  box-shadow: var(--shadow);
}

.btn-refresh:hover {
  background: var(--blue);
  color: white;
  border-color: var(--blue);
}

.btn-clear-filters {
  background: var(--red);
  color: white;
  border-color: var(--red);
  display: none;
}

.btn-clear-filters:hover {
  filter: brightness(1.1);
  transform: translateY(-2px);
}

.spinning {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.active-filters {
  background: var(--panel);
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  display: none;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  border-left: 4px solid var(--blue);
}

.active-filters .filter-label {
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
}

.active-filters .filter-tag {
  background: var(--blue);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.kpi{
  background:var(--panel);
  padding:24px;
  border-radius:18px;
  box-shadow:var(--shadow);
  text-align:center;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border: 1px solid transparent;
  cursor: pointer;
  position: relative;
}

.kpi:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  border-color: var(--blue);
}

.kpi.active {
  border-color: var(--blue);
  background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
}

.kpi i{
  font-size:18px;
  margin-bottom:10px;
  color: var(--blue);
}

.kpi h3{
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:6px;
}

.kpi p{
  font-size:32px;
  font-weight:800;
}

.kpi-hint {
  font-size: 10px;
  color: var(--muted);
  margin-top: 8px;
  opacity: 0;
  transition: opacity 0.2s;
}

.kpi:hover .kpi-hint {
  opacity: 1;
}

.charts{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.chart-box{
  background:var(--panel);
  border-radius:18px;
  padding:24px;
  box-shadow:var(--shadow);
  height:380px;
  display: flex;
  flex-direction: column;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.chart-title{
  font-size:13px;
  font-weight:700;
  color: var(--text);
}

.chart-select {
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  background: white;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
}

.chart-select:hover {
  border-color: var(--blue);
}

.chart-info {
  font-size: 11px;
  color: var(--muted);
  margin-top: 8px;
  padding: 8px 12px;
  background: #f8fafc;
  border-radius: 8px;
  display: none;
}

.chart-info.show {
  display: block;
}

.semaforo-indicator {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 6px;
}

.semaforo-verde { background: var(--green); }
.semaforo-amarelo { background: var(--yellow); }
.semaforo-vermelho { background: var(--red); }

.chart-container {
  flex: 1;
  position: relative;
  min-height: 0;
  width: 100%;
}

.table-box{
  background:var(--panel);
  border-radius:18px;
  box-shadow:var(--shadow);
  overflow-x: auto;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  min-width: 900px;
}

th{
  background:#fafafa;
  padding:16px 12px;
  font-size:11px;
  text-transform:uppercase;
  color:var(--muted);
  text-align:left;
  position: sticky;
  top: 0;
  z-index: 10;
}

th:nth-child(1) { width: 25%; }
th:nth-child(2) { width: 12%; text-align: center; }
th:nth-child(3) { width: 12%; text-align: center; }
th:nth-child(4) { width: 15%; text-align: center; }
th:nth-child(5) { width: 20%; }
th:nth-child(6) { width: 8%; text-align: center; }

td{
  padding:14px 12px;
  border-top:1px solid var(--border);
}

td:nth-child(2), td:nth-child(3), td:nth-child(4), td:nth-child(6) {
  text-align: center;
}

tr:hover{background:#f8fafc}

.badge{
  padding:6px 12px;
  border-radius:20px;
  font-size:11px;
  font-weight:600;
  display: inline-block;
  white-space: nowrap;
}

.em-andamento{
  background:var(--status-andamento-bg);
  color:var(--status-andamento-text);
}

.paralisado{
  background:var(--status-paralisado-bg);
  color:var(--status-paralisado-text);
}

.ag-cliente{
  background:var(--status-cliente-bg) !important;
  color:var(--status-cliente-text) !important;
  border: 1px solid #e9d5ff !important;
}

.planejado{
  background:var(--status-planejado-bg);
  color:var(--status-planejado-text);
}

.concluido{
  background:var(--status-concluido-bg);
  color:var(--status-concluido-text);
}

.analista-bold { font-weight: 800; }
.color-abraao { color: var(--color-abraao) !important; }
.color-dalto { color: var(--color-dalto) !important; } 
.color-jonathas { color: var(--color-jonathas) !important; } 
.color-lucas { color: var(--color-lucas) !important; }       
.color-efraim { color: var(--color-efraim) !important; }     
.color-cristhian { color: var(--color-cristhian) !important; }  
.color-ernane { color: var(--color-ernane) !important; }       
.color-william { color: var(--color-william) !important; }     
.color-default { color: var(--text) !important; }

.progress{
  display:flex;
  align-items:center;
  gap:10px;
}

.bar{
  flex:1;
  height:8px;
  background:#e5e7eb;
  border-radius:10px;
  overflow:hidden;
}

.fill{
  height:100%;
  background:linear-gradient(90deg, var(--blue), var(--green));
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

#modal{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.4);
  backdrop-filter: blur(4px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index: 1000;
}

.modal-content{
  background:#fff;
  padding:28px;
  border-radius:20px;
  width:90%;
  max-width:420px;
  box-shadow:0 30px 60px rgba(0,0,0,0.2);
  transform: scale(0.9);
  animation: modalIn 0.3s forwards;
}

@keyframes modalIn {
  to { transform: scale(1); }
}

.modal-content h2{
  margin-bottom:12px;
  color: var(--blue);
}

.modal-content p{
  line-height:1.6;
  color: var(--text);
  white-space: pre-wrap;
}

.btn-modal{
  border:none;
  background:var(--blue);
  color:#fff;
  padding:12px;
  border-radius:12px;
  width:100%;
  font-weight:700;
  margin-top:20px;
  cursor:pointer;
  transition: all 0.2s;
}

.btn-modal:hover { 
  filter: brightness(1.1);
  transform: translateY(-2px);
}

#loading {
  position: fixed;
  top: 10px;
  right: 10px;
  background: var(--blue);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: none;
  z-index: 1100;
  box-shadow: var(--shadow);
}

#debugPanel {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(0, 0, 0, 0.9);
  color: #00ff00;
  padding: 12px;
  border-radius: 8px;
  font-family: 'Courier New', monospace;
  font-size: 11px;
  max-width: 400px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1100;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  display: none;
}

#debugPanel .debug-line {
  margin: 2px 0;
  line-height: 1.4;
}

#debugPanel .debug-error {
  color: #ff4444;
}

#debugPanel .debug-success {
  color: #00ff00;
}

#debugPanel .debug-warning {
  color: #ffaa00;
}

#debugToggle {
  position: fixed;
  bottom: 10px;
  left: 10px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 11px;
  cursor: pointer;
  z-index: 1100;
  font-family: monospace;
}

#debugToggle:hover {
  background: rgba(0, 0, 0, 0.9);
}

.no-results {
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}

.no-results i {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.no-results h3 {
  font-size: 18px;
  margin-bottom: 8px;
  color: var(--text);
}

@media (max-width: 768px) {
  body { padding: 15px; }
  header { flex-direction: column; align-items: flex-start; }
  .kpis { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
  .charts { grid-template-columns: 1fr; }
  .chart-box { height: 320px; }
}
</style>
</head>

<body>
<div id="loading">üîÑ Sincronizando dados...</div>
<button id="debugToggle" onclick="toggleDebug()">üêõ DEBUG</button>
<div id="debugPanel"></div>

<div class="container">

<header>
  <h1>OKVENDAS <span>PMO</span></h1>
  <div class="header-actions">
    <button class="btn-clear-filters" id="btnClearFilters" onclick="clearAllFilters()">
      <i class="fa-solid fa-filter-circle-xmark"></i> Limpar Filtros
    </button>
    <button class="btn-refresh" onclick="fetchData()">
      <i class="fa-solid fa-arrows-rotate" id="refresh-icon"></i> Atualizar Dados
    </button>
    <div style="font-size:13px;color:var(--muted)">
      <i class="fa-solid fa-circle" style="color:var(--green);font-size:8px"></i>
      Auto-sincroniza√ß√£o ativa
    </div>
  </div>
</header>

<div class="active-filters" id="activeFilters">
  <span class="filter-label"><i class="fa-solid fa-filter"></i> Filtros ativos:</span>
  <div id="filterTags"></div>
</div>

<div class="kpis">
  <div class="kpi" onclick="filterByStatus('all')">
    <i class="fa-solid fa-folder-tree"></i>
    <h3>Total Projetos</h3>
    <p id="kTotal">0</p>
    <div class="kpi-hint">Clique para ver todos</div>
  </div>
  <div class="kpi" onclick="filterByStatus('andamento')">
    <i class="fa-solid fa-rocket"></i>
    <h3>Em Andamento</h3>
    <p id="kAtivos">0</p>
    <div class="kpi-hint">Clique para filtrar</div>
  </div>
  <div class="kpi" onclick="filterByStatus('paralisado')">
    <i class="fa-solid fa-pause"></i>
    <h3>Pausados</h3>
    <p id="kPausados">0</p>
    <div class="kpi-hint">Clique para filtrar</div>
  </div>
  <div class="kpi" onclick="filterByStatus('cliente')">
    <i class="fa-solid fa-clock-rotate-left"></i>
    <h3>Ag. Cliente</h3>
    <p id="kCliente">0</p>
    <div class="kpi-hint">Clique para filtrar</div>
  </div>
</div>

<div class="charts">
  <div class="chart-box">
    <div class="chart-header">
      <div class="chart-title">Acompanhamento Curva S</div>
      <select class="chart-select" id="projectSelect" onchange="updateCurvaS()">
        <option value="all">Vis√£o Geral</option>
      </select>
    </div>
    <div class="chart-container"><canvas id="curve"></canvas></div>
    <div class="chart-info" id="curvaInfo"></div>
  </div>
  
  <div class="chart-box">
    <div class="chart-header">
      <div class="chart-title">Carga por Analista</div>
      <div style="font-size:10px;color:var(--muted)">Clique nas barras para filtrar</div>
    </div>
    <div class="chart-container"><canvas id="analistas"></canvas></div>
  </div>
  
  <div class="chart-box">
    <div class="chart-header">
      <div class="chart-title">Distribui√ß√£o de Status</div>
    </div>
    <div class="chart-container"><canvas id="status"></canvas></div>
  </div>
</div>

<div class="table-box">
<table>
<thead>
<tr>
  <th>Projeto</th>
  <th>Analista</th>
  <th>Status</th>
  <th>Data Prevista</th>
  <th>Evolu√ß√£o</th>
  <th>Info</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<div id="modal">
  <div class="modal-content">
    <h2 id="mTitle"></h2>
    <p id="mObs"></p>
    <button class="btn-modal" onclick="closeModal()">Fechar Detalhes</button>
  </div>
</div>

<script>
// ========== CONFIGURA√á√ÉO ==========
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSN6220bHIwZ9pzMZkhQ1hBT32sofXNn-FSvJYDNGFVKNCtEhpTqF3yg4zz-p25nALcm1J33QeLR_pn/pub?gid=378165818&single=true&output=csv';

let projectData = [];
let charts = {};
let currentFilters = { analista: null, status: null, projeto: null };

// ========== DEBUG ==========
const debugLogs = [];
const MAX_DEBUG_LOGS = 50;

function debugLog(message, type = 'info') {
  const timestamp = new Date().toLocaleTimeString('pt-BR');
  debugLogs.push({ timestamp, message, type });
  if (debugLogs.length > MAX_DEBUG_LOGS) debugLogs.shift();
  
  const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
  console.log(`${emoji} [${timestamp}] ${message}`);
  updateDebugPanel();
}

function toggleDebug() {
  const panel = document.getElementById('debugPanel');
  panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
  if (panel.style.display === 'block') updateDebugPanel();
}

function updateDebugPanel() {
  const panel = document.getElementById('debugPanel');
  if (panel.style.display === 'block') {
    panel.innerHTML = debugLogs.map(log => {
      const className = log.type === 'error' ? 'debug-error' : 
                        log.type === 'success' ? 'debug-success' : 
                        log.type === 'warning' ? 'debug-warning' : '';
      return `<div class="debug-line ${className}">[${log.timestamp}] ${log.message}</div>`;
    }).reverse().join('');
    panel.scrollTop = 0;
  }
}

// ========== FUN√á√ïES AUXILIARES ==========
function cleanKey(str) {
  if (!str) return "";
  return str.toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function getAnalistaClass(nome) {
  if (!nome) return 'color-default';
  const n = cleanKey(nome);
  if (n.includes('abraao')) return 'color-abraao';
  if (n.includes('dalto')) return 'color-dalto';
  if (n.includes('jonathas')) return 'color-jonathas';
  if (n.includes('lucas')) return 'color-lucas';
  if (n.includes('efraim')) return 'color-efraim';
  if (n.includes('cristhian')) return 'color-cristhian';
  if (n.includes('ernane')) return 'color-ernane';
  if (n.includes('william')) return 'color-william';
  return 'color-default';
}

function getAnalistaColor(nome) {
  if (!nome) return '#94a3b8';
  const n = cleanKey(nome);
  if (n.includes('abraao')) return '#FFB800';
  if (n.includes('dalto')) return '#f97316';
  if (n.includes('jonathas')) return '#38bdf8';
  if (n.includes('lucas')) return '#0369a1';
  if (n.includes('efraim')) return '#0d9488';
  if (n.includes('cristhian')) return '#475569';
  if (n.includes('ernane')) return '#1e3a8a';
  if (n.includes('william')) return '#16a34a';
  return '#94a3b8';
}

function getStatusColor(status) {
  const s = cleanKey(status);
  if (s.includes('andamento')) return '#10b981';
  if (s.includes('paralisado')) return '#ef4444';
  if (s.includes('cliente')) return '#8b5cf6';
  if (s.includes('planejado')) return '#94a3b8';
  if (s.includes('concluido')) return '#0ea5e9';
  return '#f59e0b';
}

function getSemaforoColor(diferenca) {
  if (Math.abs(diferenca) <= 10) return 'verde';
  if (Math.abs(diferenca) <= 25) return 'amarelo';
  return 'vermelho';
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let insideQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    const nextChar = line[i + 1];
    
    if (char === '"') {
      if (insideQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        insideQuotes = !insideQuotes;
      }
    } else if (char === ',' && !insideQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  
  result.push(current.trim());
  return result;
}

// ========== FETCH DATA ==========
async function fetchData() {
  const loadingEl = document.getElementById('loading');
  const refreshIcon = document.getElementById('refresh-icon');
  
  loadingEl.style.display = 'block';
  if (refreshIcon) refreshIcon.classList.add('spinning');
  
  debugLog('üîÑ Iniciando carregamento...');
  debugLog(`üìä URL: ${SHEET_CSV_URL.substring(0, 80)}...`);
  
  try {
    const url = `${SHEET_CSV_URL}&cachebust=${Date.now()}`;
    debugLog('üåê Fazendo fetch...');
    
    const response = await fetch(url);
    debugLog(`üì° Status: ${response.status}`, response.ok ? 'success' : 'error');
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const csvData = await response.text();
    debugLog(`üìù Recebido: ${csvData.length} caracteres`);
    
    const lines = csvData.split(/\r?\n/).filter(l => l.trim());
    debugLog(`üìä Linhas: ${lines.length}`, 'success');
    
    if (lines.length < 2) throw new Error("Planilha vazia");
    
    const headers = parseCSVLine(lines[0]);
    debugLog(`üìã Colunas: ${headers.join(', ')}`);
    
    const colMap = {};
    headers.forEach((h, i) => colMap[cleanKey(h)] = i);
    
    const findCol = (names) => {
      for (let n of names) {
        const idx = colMap[cleanKey(n)];
        if (idx !== undefined) return idx;
      }
      return -1;
    };
    
    const colIdx = {
      projeto: findCol(['projeto', 'nome']),
      status: findCol(['status', 'situacao']),
      analista: findCol(['analista', 'responsavel']),
      obs: findCol(['obs', 'observacao']),
      dataPrevista: findCol(['data prevista', 'previsao', 'prazo']),
      concluidas: findCol(['concluidas']),
      validacao: findCol(['em validacao', 'validacao']),
      liberacao: findCol(['ag liberacao', 'liberacao']),
      execucao: findCol(['em execucao', 'execucao']),
      inicio: findCol(['ag inicio', 'inicio']),
      descricao: findCol(['ag descricao', 'descricao'])
    };
    
    debugLog(`üîç Projeto: col ${colIdx.projeto}, Status: col ${colIdx.status}`);
    
    projectData = [];
    
    for (let i = 1; i < lines.length; i++) {
      const values = parseCSVLine(lines[i]);
      if (colIdx.projeto < 0 || !values[colIdx.projeto]?.trim()) continue;
      
      const getValue = (idx, def = "") => (idx >= 0 && values[idx]) ? values[idx].trim() : def;
      const getNum = (idx) => {
        if (idx < 0) return 0;
        const val = values[idx]?.trim() || "0";
        return parseInt(val.replace(/\D/g, '')) || 0;
      };
      
      const concluidas = getNum(colIdx.concluidas);
      const total = concluidas + getNum(colIdx.validacao) + getNum(colIdx.liberacao) + 
                    getNum(colIdx.execucao) + getNum(colIdx.inicio) + getNum(colIdx.descricao);
      
      projectData.push({
        Projeto: getValue(colIdx.projeto),
        Status: getValue(colIdx.status, "Planejado"),
        Analista: getValue(colIdx.analista, "N/A"),
        DataPrevista: getValue(colIdx.dataPrevista, "-"),
        Concluidas: concluidas,
        Total: total,
        Obs: getValue(colIdx.obs, "Sem observa√ß√µes.")
      });
    }
    
    debugLog(`‚úÖ ${projectData.length} projetos carregados!`, 'success');
    
    populateProjectSelect();
    renderAll();
    
    debugLog('üéâ Dashboard renderizado!', 'success');
    
  } catch (error) {
    debugLog(`‚ùå ERRO: ${error.message}`, 'error');
    
    let msg = `Erro ao carregar dados:\n\n${error.message}\n\n`;
    
    if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
      msg += 'üîí SOLU√á√ïES:\n\n';
      msg += '1. Verifique se a planilha est√° publicada\n';
      msg += '2. V√° em Arquivo > Compartilhar > Publicar na web\n';
      msg += '3. Selecione a aba correta e formato CSV\n';
      msg += '4. Clique em "Publicar"\n';
      msg += '5. Use a URL gerada\n';
    }
    
    alert(msg);
  } finally {
    loadingEl.style.display = 'none';
    if (refreshIcon) refreshIcon.classList.remove('spinning');
  }
}

function populateProjectSelect() {
  const select = document.getElementById('projectSelect');
  select.innerHTML = '<option value="all">Vis√£o Geral</option>';
  projectData.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.Projeto;
    opt.textContent = p.Projeto;
    select.appendChild(opt);
  });
}

// ========== FILTROS ==========
function filterByAnalista(analista) {
  currentFilters.analista = currentFilters.analista === analista ? null : analista;
  updateFilters();
}

function filterByStatus(status) {
  if (status === 'all') {
    currentFilters.status = null;
  } else {
    currentFilters.status = currentFilters.status === status ? null : status;
  }
  updateFilters();
}

function clearAllFilters() {
  currentFilters = { analista: null, status: null, projeto: null };
  document.getElementById('projectSelect').value = 'all';
  updateFilters();
}

function updateFilters() {
  renderAll();
  updateFilterDisplay();
  if (currentFilters.analista || currentFilters.status) {
    setTimeout(() => {
      document.querySelector('.table-box')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);
  }
}

function updateFilterDisplay() {
  const activeFiltersEl = document.getElementById('activeFilters');
  const filterTagsEl = document.getElementById('filterTags');
  const btnClear = document.getElementById('btnClearFilters');
  
  const hasFilters = currentFilters.analista || currentFilters.status;
  
  if (hasFilters) {
    activeFiltersEl.style.display = 'flex';
    btnClear.style.display = 'flex';
    
    let tags = '';
    if (currentFilters.analista) tags += `<span class="filter-tag">Analista: ${currentFilters.analista}</span>`;
    if (currentFilters.status) {
      const labels = { andamento: 'Em Andamento', paralisado: 'Paralisado', cliente: 'Ag. Cliente' };
      tags += `<span class="filter-tag">Status: ${labels[currentFilters.status] || currentFilters.status}</span>`;
    }
    filterTagsEl.innerHTML = tags;
  } else {
    activeFiltersEl.style.display = 'none';
    btnClear.style.display = 'none';
  }
  
  document.querySelectorAll('.kpi').forEach(kpi => kpi.classList.remove('active'));
  const kpis = document.querySelectorAll('.kpi');
  if (currentFilters.status === 'andamento') kpis[1]?.classList.add('active');
  else if (currentFilters.status === 'paralisado') kpis[2]?.classList.add('active');
  else if (currentFilters.status === 'cliente') kpis[3]?.classList.add('active');
  else if (!currentFilters.status) kpis[0]?.classList.add('active');
}

function getFilteredData() {
  let filtered = [...projectData];
  if (currentFilters.analista) filtered = filtered.filter(p => p.Analista === currentFilters.analista);
  if (currentFilters.status) filtered = filtered.filter(p => cleanKey(p.Status).includes(currentFilters.status));
  return filtered;
}

// ========== RENDER ==========
function renderAll() {
  const filtered = getFilteredData();
  renderTable(filtered);
  renderKPIs(projectData);
  renderCharts(filtered);
}

function renderTable(p) {
  const tb = document.getElementById("tbody");
  if (p.length === 0) {
    tb.innerHTML = `<tr><td colspan="6"><div class="no-results"><i class="fa-solid fa-inbox"></i><h3>Nenhum projeto encontrado</h3><p style="margin-top:8px;font-size:13px">Ajuste os filtros</p></div></td></tr>`;
    return;
  }
  
  tb.innerHTML = p.map(x => {
    const perc = x.Total > 0 ? Math.round((x.Concluidas / x.Total) * 100) : 0;
    const statusClass = cleanKey(x.Status).replace(/\./g, "").replace(/\s/g, '-');
    const analistaClass = getAnalistaClass(x.Analista);
    
    return `<tr>
      <td><strong>${x.Projeto}</strong></td>
      <td class="analista-bold ${analistaClass}">${x.Analista}</td>
      <td><span class="badge ${statusClass}">${x.Status}</span></td>
      <td>${x.DataPrevista}</td>
      <td><div class="progress"><div class="bar"><div class="fill" style="width:${perc}%"></div></div><strong style="width:35px;text-align:right">${perc}%</strong></div></td>
      <td><i class="fa-solid fa-circle-info" style="cursor:pointer;color:var(--blue)" onclick='openModal(\`${x.Projeto}\`,\`${x.Obs}\`)'></i></td>
    </tr>`;
  }).join("");
}

function renderKPIs(p) {
  document.getElementById("kTotal").innerText = p.length;
  document.getElementById("kAtivos").innerText = p.filter(x => cleanKey(x.Status).includes("andamento")).length;
  document.getElementById("kPausados").innerText = p.filter(x => cleanKey(x.Status).includes("paralisado")).length;
  document.getElementById("kCliente").innerText = p.filter(x => cleanKey(x.Status).includes("cliente")).length;
}

function renderCharts(p) {
  if (p.length === 0) {
    Object.values(charts).forEach(c => c.destroy());
    charts = {};
    return;
  }
  
  const analistasCount = {};
  const statusCount = {};
  p.forEach(x => {
    analistasCount[x.Analista] = (analistasCount[x.Analista] || 0) + 1;
    statusCount[x.Status] = (statusCount[x.Status] || 0) + 1;
  });
  
  Object.values(charts).forEach(c => c.destroy());
  
  const analistaLabels = Object.keys(analistasCount);
  const analistaColors = analistaLabels.map(n => getAnalistaColor(n));
  
  charts.analistas = new Chart(document.getElementById('analistas'), {
    type: 'bar',
    data: {
      labels: analistaLabels,
      datasets: [{ data: Object.values(analistasCount), backgroundColor: analistaColors, borderRadius: 6, barThickness: 20 }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      onClick: (e, elements) => {
        if (elements.length > 0) {
          const analista = analistaLabels[elements[0].index];
          filterByAnalista(analista);
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: (ctx) => `${ctx.parsed.x} projeto(s)` } }
      },
      scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
  
  const statusLabels = Object.keys(statusCount);
  const statusColors = statusLabels.map(s => getStatusColor(s));
  
  charts.status = new Chart(document.getElementById('status'), {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{ data: Object.values(statusCount), backgroundColor: statusColors, borderWidth: 0, hoverOffset: 10 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11, weight: '600' } } },
        tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${ctx.parsed} projeto(s)` } }
      }
    }
  });
  
  updateCurvaS();
}

function updateCurvaS() {
  const select = document.getElementById('projectSelect');
  const selectedProject = select.value;
  const curvaInfoEl = document.getElementById('curvaInfo');
  
  let data, label, cor, diferenca;
  
  if (selectedProject === 'all') {
    const filtered = getFilteredData();
    const media = filtered.length > 0 
      ? Math.round(filtered.reduce((acc, curr) => acc + (curr.Total > 0 ? (curr.Concluidas / curr.Total) * 100 : 0), 0) / filtered.length)
      : 0;
    
    diferenca = 100 - media;
    const semaforo = getSemaforoColor(diferenca);
    cor = semaforo === 'verde' ? '#10b981' : semaforo === 'amarelo' ? '#f59e0b' : '#ef4444';
    
    data = [0, media];
    label = 'Realizado (M√©dia Geral)';
    
    curvaInfoEl.innerHTML = `<span class="semaforo-indicator semaforo-${semaforo}"></span><strong>Diferen√ßa: ${diferenca.toFixed(1)}%</strong> entre planejado e realizado`;
    curvaInfoEl.classList.add('show');
  } else {
    const projeto = projectData.find(p => p.Projeto === selectedProject);
    if (projeto) {
      const perc = projeto.Total > 0 ? Math.round((projeto.Concluidas / projeto.Total) * 100) : 0;
      diferenca = 100 - perc;
      const semaforo = getSemaforoColor(diferenca);
      cor = semaforo === 'verde' ? '#10b981' : semaforo === 'amarelo' ? '#f59e0b' : '#ef4444';
      
      data = [0, perc];
      label = `Realizado (${projeto.Projeto})`;
      
      curvaInfoEl.innerHTML = `<span class="semaforo-indicator semaforo-${semaforo}"></span><strong>Diferen√ßa: ${diferenca.toFixed(1)}%</strong> entre planejado e realizado | <strong>${projeto.Concluidas}/${projeto.Total}</strong> atividades`;
      curvaInfoEl.classList.add('show');
    }
  }
  
  if (charts.curve) charts.curve.destroy();
  
  charts.curve = new Chart(document.getElementById('curve'), {
    type: 'line',
    data: {
      labels: ['In√≠cio', 'Progresso Atual'],
      datasets: [
        { label: 'Meta Planejada', data: [0, 100], borderColor: '#94a3b8', borderDash: [5, 5], borderWidth: 2, fill: false, tension: 0.4, pointRadius: 4 },
        { label: label, data: data, borderColor: cor, backgroundColor: cor + '20', fill: true, tension: 0.4, pointRadius: 5, pointHoverRadius: 7 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11, weight: '600' } } },
        tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}%` } }
      },
      scales: { y: { beginAtZero: true, max: 100, ticks: { callback: (v) => v + '%' } } }
    }
  });
}

// ========== MODAL ==========
function openModal(title, obs) {
  document.getElementById("mTitle").textContent = title;
  document.getElementById("mObs").textContent = obs;
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

window.onclick = e => {
  if (e.target == document.getElementById("modal")) closeModal();
}

// ========== INIT ==========
window.onload = fetchData;
setInterval(fetchData, 300000);
window.addEventListener('beforeunload', clearAllFilters);
</script>
</body>
</html>
