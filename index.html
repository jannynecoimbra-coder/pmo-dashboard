<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PMO | OkVendas</title>

<!-- Fontes e libs -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
:root{
  /* ========== CORES PRINCIPAIS - PERSONALIZE AQUI ========== */
  --bg:#f1f5f9;
  --panel:#ffffff;
  --blue:#0ea5e9;
  --green:#10b981;
  --yellow:#f59e0b;
  --red:#ef4444;
  --purple:#8b5cf6;
  --text:#334155;
  --muted:#94a3b8;
  --border:#e5e7eb;
  --shadow:0 10px 30px rgba(0,0,0,.05);
  
  /* ========== CORES DOS ANALISTAS - PERSONALIZE AQUI ========== */
  --color-abraao: #FFB800;
  --color-dalto: #f97316;
  --color-jonathas: #38bdf8;
  --color-lucas: #0369a1;
  --color-efraim: #0d9488;
  --color-cristhian: #475569;
  --color-ernane: #1e3a8a;
  --color-william: #16a34a;
  
  /* ========== CORES DOS STATUS - PERSONALIZE AQUI ========== */
  --status-andamento-bg: #dcfce7;
  --status-andamento-text: #166534;
  --status-paralisado-bg: #fee2e2;
  --status-paralisado-text: #991b1b;
  --status-cliente-bg: #f3e8ff;
  --status-cliente-text: #7e22ce;
  --status-planejado-bg: #e5e7eb;
  --status-planejado-text: #475569;
  --status-concluido-bg: #dbeafe;
  --status-concluido-text: #1e40af;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  background:var(--bg);
  font-family:'Inter',sans-serif;
  color:var(--text);
  padding:24px;
  overflow-x: hidden;
}

.container{max-width:1400px;margin:auto}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:28px;
  flex-wrap: wrap;
  gap: 15px;
}

header h1{
  font-size:24px;
  font-weight:800;
  color:var(--blue);
}

header span{
  font-weight:300;
  color:var(--muted);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

.btn-refresh {
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 16px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s;
  box-shadow: var(--shadow);
}

.btn-refresh:hover {
  background: var(--blue);
  color: white;
  border-color: var(--blue);
}

.btn-refresh i {
  font-size: 14px;
}

.spinning {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* KPIs */
.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.kpi{
  background:var(--panel);
  padding:24px;
  border-radius:18px;
  box-shadow:var(--shadow);
  text-align:center;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border: 1px solid transparent;
}

.kpi:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  border-color: var(--border);
}

.kpi i{
  font-size:18px;
  margin-bottom:10px;
  color: var(--blue);
}

.kpi h3{
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:6px;
}

.kpi p{
  font-size:32px;
  font-weight:800;
}

/* Charts */
.charts{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.chart-box{
  background:var(--panel);
  border-radius:18px;
  padding:24px;
  box-shadow:var(--shadow);
  height:350px;
  display: flex;
  flex-direction: column;
}

.chart-title{
  font-size:13px;
  font-weight:700;
  margin-bottom:16px;
  color: var(--text);
}

.chart-container {
  flex: 1;
  position: relative;
  min-height: 0;
  width: 100%;
}

/* Table */
.table-box{
  background:var(--panel);
  border-radius:18px;
  box-shadow:var(--shadow);
  overflow-x: auto;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  min-width: 800px;
}

th{
  background:#fafafa;
  padding:16px;
  font-size:11px;
  text-transform:uppercase;
  color:var(--muted);
  text-align:left;
}

th:nth-child(2), td:nth-child(2),
th:nth-child(3), td:nth-child(3),
th:nth-child(5), td:nth-child(5) {
  text-align: center;
}

td{
  padding:14px 16px;
  border-top:1px solid var(--border);
}

tr:hover{background:#f8fafc}

/* Status Badges */
.badge{
  padding:6px 12px;
  border-radius:20px;
  font-size:11px;
  font-weight:600;
  display: inline-block;
  white-space: nowrap;
}

.em-andamento{
  background:var(--status-andamento-bg);
  color:var(--status-andamento-text);
}

.paralisado{
  background:var(--status-paralisado-bg);
  color:var(--status-paralisado-text);
}

.ag-cliente{
  background:var(--status-cliente-bg) !important;
  color:var(--status-cliente-text) !important;
  border: 1px solid #e9d5ff !important;
}

.planejado{
  background:var(--status-planejado-bg);
  color:var(--status-planejado-text);
}

.concluido{
  background:var(--status-concluido-bg);
  color:var(--status-concluido-text);
}

/* Estilos de Analistas */
.analista-bold { font-weight: 800; }
.color-abraao { color: var(--color-abraao) !important; }
.color-dalto { color: var(--color-dalto) !important; } 
.color-jonathas { color: var(--color-jonathas) !important; } 
.color-lucas { color: var(--color-lucas) !important; }       
.color-efraim { color: var(--color-efraim) !important; }     
.color-cristhian { color: var(--color-cristhian) !important; }  
.color-ernane { color: var(--color-ernane) !important; }       
.color-william { color: var(--color-william) !important; }     
.color-default { color: var(--text) !important; }

/* Progress */
.progress{
  display:flex;
  align-items:center;
  gap:10px;
}

.bar{
  flex:1;
  height:8px;
  background:#e5e7eb;
  border-radius:10px;
  overflow:hidden;
}

.fill{
  height:100%;
  background:linear-gradient(90deg, var(--blue), var(--green));
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Modal */
#modal{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.4);
  backdrop-filter: blur(4px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index: 1000;
}

.modal-content{
  background:#fff;
  padding:28px;
  border-radius:20px;
  width:90%;
  max-width:420px;
  box-shadow:0 30px 60px rgba(0,0,0,0.2);
  transform: scale(0.9);
  animation: modalIn 0.3s forwards;
}

@keyframes modalIn {
  to { transform: scale(1); }
}

.modal-content h2{
  margin-bottom:12px;
  color: var(--blue);
}

.modal-content p{
  line-height:1.6;
  color: var(--text);
  white-space: pre-wrap;
}

.btn-modal{
  border:none;
  background:var(--blue);
  color:#fff;
  padding:12px;
  border-radius:12px;
  width:100%;
  font-weight:700;
  margin-top:20px;
  cursor:pointer;
  transition: all 0.2s;
}

.btn-modal:hover { 
  filter: brightness(1.1);
  transform: translateY(-2px);
}

#loading {
  position: fixed;
  top: 10px;
  right: 10px;
  background: var(--blue);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: none;
  z-index: 1100;
  box-shadow: var(--shadow);
}

/* Responsividade */
@media (max-width: 768px) {
  body { padding: 15px; }
  header { flex-direction: column; align-items: flex-start; }
  .kpis { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
  .charts { grid-template-columns: 1fr; }
}
</style>
</head>

<body>
<div id="loading">üîÑ Sincronizando dados...</div>

<div class="container">

<header>
  <h1>OKVENDAS <span>PMO</span></h1>
  <div class="header-actions">
    <button class="btn-refresh" onclick="fetchData()">
      <i class="fa-solid fa-arrows-rotate" id="refresh-icon"></i> Atualizar Dados
    </button>
    <div style="font-size:13px;color:var(--muted)">
      <i class="fa-solid fa-circle" style="color:var(--green);font-size:8px"></i>
      Auto-sincroniza√ß√£o ativa
    </div>
  </div>
</header>

<div class="kpis">
  <div class="kpi"><i class="fa-solid fa-folder-tree"></i><h3>Total Projetos</h3><p id="kTotal">0</p></div>
  <div class="kpi"><i class="fa-solid fa-rocket"></i><h3>Ativos</h3><p id="kAtivos">0</p></div>
  <div class="kpi"><i class="fa-solid fa-pause"></i><h3>Pausados</h3><p id="kPausados">0</p></div>
  <div class="kpi"><i class="fa-solid fa-clock-rotate-left"></i><h3>Ag. Cliente</h3><p id="kCliente">0</p></div>
</div>

<div class="charts">
  <div class="chart-box"><div class="chart-title">Acompanhamento Curva S</div><div class="chart-container"><canvas id="curve"></canvas></div></div>
  <div class="chart-box"><div class="chart-title">Carga por Analista</div><div class="chart-container"><canvas id="analistas"></canvas></div></div>
  <div class="chart-box"><div class="chart-title">Distribui√ß√£o de Status</div><div class="chart-container"><canvas id="status"></canvas></div></div>
</div>

<div class="table-box">
<table>
<thead>
<tr>
  <th>Projeto</th>
  <th>Analista</th>
  <th>Status</th>
  <th>Evolu√ß√£o</th>
  <th>Info</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<div id="modal">
  <div class="modal-content">
    <h2 id="mTitle"></h2>
    <p id="mObs"></p>
    <button class="btn-modal" onclick="closeModal()">Fechar Detalhes</button>
  </div>
</div>

<script>
// ========== CONFIGURA√á√ÉO DA PLANILHA ==========
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSN6220bHIwZ9pzMZkhQ1hBT32sofXNn-FSvJYDNGFVKNCtEhpTqF3yg4zz-p25nALcm1J33QeLR_pn/pub?gid=378165818&single=true&output=csv';

let projectData = [];
let charts = {};

// ========== FUN√á√ïES AUXILIARES ==========
function cleanKey(str) {
  if (!str) return "";
  return str.toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function getAnalistaClass(nome) {
  if (!nome) return 'color-default';
  const n = cleanKey(nome);
  
  if (n.includes('abraao')) return 'color-abraao';
  if (n.includes('dalto')) return 'color-dalto';
  if (n.includes('jonathas')) return 'color-jonathas';
  if (n.includes('lucas')) return 'color-lucas';
  if (n.includes('efraim')) return 'color-efraim';
  if (n.includes('cristhian')) return 'color-cristhian';
  if (n.includes('ernane')) return 'color-ernane';
  if (n.includes('william')) return 'color-william';
  
  return 'color-default';
}

function getStatusColor(status) {
  const s = cleanKey(status);
  
  if (s.includes('andamento')) return '#10b981'; // Verde
  if (s.includes('paralisado')) return '#ef4444'; // Vermelho
  if (s.includes('cliente')) return '#8b5cf6'; // Roxo
  if (s.includes('planejado')) return '#94a3b8'; // Cinza
  if (s.includes('concluido')) return '#0ea5e9'; // Azul
  
  return '#f59e0b'; // Amarelo (default)
}

// ========== PARSER CSV ROBUSTO ==========
function parseCSVLine(line) {
  const result = [];
  let current = '';
  let insideQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    const nextChar = line[i + 1];
    
    if (char === '"') {
      if (insideQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        insideQuotes = !insideQuotes;
      }
    } else if (char === ',' && !insideQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  
  result.push(current.trim());
  return result;
}

// ========== BUSCAR DADOS DA PLANILHA ==========
async function fetchData() {
  const loadingEl = document.getElementById('loading');
  const refreshIcon = document.getElementById('refresh-icon');
  
  loadingEl.style.display = 'block';
  if (refreshIcon) refreshIcon.classList.add('spinning');
  
  try {
    const url = `${SHEET_CSV_URL}&t=${Date.now()}`;
    
    const response = await fetch(url, {
      cache: 'no-cache',
      headers: {
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }
    
    const csvData = await response.text();
    const lines = csvData.split(/\r?\n/).filter(l => l.trim() !== "");
    
    if (lines.length < 2) {
      throw new Error("Planilha vazia ou sem dados");
    }
    
    // Processar cabe√ßalho
    const headers = parseCSVLine(lines[0]);
    const colMap = {};
    headers.forEach((header, idx) => {
      colMap[cleanKey(header)] = idx;
    });
    
    // Mapear colunas
    const findCol = (names) => {
      for (let name of names) {
        const idx = colMap[cleanKey(name)];
        if (idx !== undefined) return idx;
      }
      return -1;
    };
    
    const colIdx = {
      projeto: findCol(['projeto', 'nome', 'name']),
      status: findCol(['status', 'situacao']),
      analista: findCol(['analista', 'responsavel']),
      obs: findCol(['obs', 'observacao', 'observacoes']),
      concluidas: findCol(['concluidas', 'concluida']),
      validacao: findCol(['em validacao', 'validacao']),
      liberacao: findCol(['ag liberacao', 'liberacao', 'ag. liberacao']),
      execucao: findCol(['em execucao', 'execucao']),
      inicio: findCol(['ag inicio', 'inicio', 'ag. inicio']),
      descricao: findCol(['ag descricao', 'descricao', 'ag. descricao'])
    };
    
    // Processar dados
    projectData = [];
    
    for (let i = 1; i < lines.length; i++) {
      const values = parseCSVLine(lines[i]);
      
      // Validar linha
      if (colIdx.projeto < 0 || !values[colIdx.projeto] || values[colIdx.projeto].trim() === "") {
        continue;
      }
      
      // Extrair valores
      const getValue = (idx, defaultVal = "") => {
        return idx >= 0 && values[idx] ? values[idx].trim() : defaultVal;
      };
      
      const getNumber = (idx) => {
        if (idx < 0) return 0;
        const val = values[idx] ? values[idx].trim() : "0";
        const num = parseInt(val.replace(/\D/g, '')) || 0;
        return num;
      };
      
      const projeto = getValue(colIdx.projeto);
      const status = getValue(colIdx.status, "Planejado");
      const analista = getValue(colIdx.analista, "N/A");
      const obs = getValue(colIdx.obs, "Sem observa√ß√µes.");
      
      const concluidas = getNumber(colIdx.concluidas);
      const validacao = getNumber(colIdx.validacao);
      const liberacao = getNumber(colIdx.liberacao);
      const execucao = getNumber(colIdx.execucao);
      const inicio = getNumber(colIdx.inicio);
      const descricao = getNumber(colIdx.descricao);
      
      const total = concluidas + validacao + liberacao + execucao + inicio + descricao;
      
      projectData.push({
        Projeto: projeto,
        Status: status,
        Analista: analista,
        Concluidas: concluidas,
        Total: total,
        Obs: obs
      });
    }
    
    // Renderizar tudo
    renderAll();
    
  } catch (error) {
    console.error("Erro ao carregar dados:", error);
    alert(`Erro ao carregar dados da planilha:\n${error.message}\n\nVerifique se a planilha est√° publicada corretamente.`);
  } finally {
    loadingEl.style.display = 'none';
    if (refreshIcon) refreshIcon.classList.remove('spinning');
  }
}

// ========== RENDERIZAR TUDO ==========
function renderAll() {
  renderTable(projectData);
  renderKPIs(projectData);
  renderCharts(projectData);
}

// ========== RENDERIZAR TABELA ==========
function renderTable(p){
  const tb = document.getElementById("tbody");
  
  if (p.length === 0) {
    tb.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--muted)">Nenhum projeto encontrado</td></tr>';
    return;
  }
  
  tb.innerHTML = p.map(x=>{
    const perc = x.Total > 0 ? Math.round((x.Concluidas/x.Total)*100) : 0;
    const statusClass = cleanKey(x.Status).replace(/\./g, "").replace(/\s/g,'-');
    const analistaColorClass = getAnalistaClass(x.Analista);
    
    return `
    <tr>
      <td><strong>${x.Projeto}</strong></td>
      <td class="analista-bold ${analistaColorClass}">${x.Analista}</td>
      <td><span class="badge ${statusClass}">${x.Status}</span></td>
      <td><div class="progress"><div class="bar"><div class="fill" style="width:${perc}%"></div></div><strong style="width:35px;text-align:right">${perc}%</strong></div></td>
      <td><i class="fa-solid fa-circle-info" style="cursor:pointer;color:var(--blue)" onclick='openModal(\`${x.Projeto}\`,\`${x.Obs}\`)'></i></td>
    </tr>`;
  }).join("");
}

// ========== RENDERIZAR KPIs ==========
function renderKPIs(p){
  document.getElementById("kTotal").innerText = p.length;
  document.getElementById("kAtivos").innerText = p.filter(x => cleanKey(x.Status).includes("andamento")).length;
  document.getElementById("kPausados").innerText = p.filter(x => cleanKey(x.Status).includes("paralisado")).length;
  document.getElementById("kCliente").innerText = p.filter(x => cleanKey(x.Status).includes("cliente")).length;
}

// ========== RENDERIZAR GR√ÅFICOS ==========
function renderCharts(p){
  if (p.length === 0) return;
  
  // Contagens
  const analistasCount = {};
  const statusCount = {};
  
  p.forEach(x=>{
    analistasCount[x.Analista] = (analistasCount[x.Analista] || 0) + 1;
    statusCount[x.Status] = (statusCount[x.Status] || 0) + 1;
  });

  // Destruir gr√°ficos antigos
  Object.values(charts).forEach(c => c.destroy());

  // Gr√°fico de Analistas
  charts.analistas = new Chart(document.getElementById('analistas'), {
    type: 'bar',
    data: {
      labels: Object.keys(analistasCount),
      datasets: [{ 
        data: Object.values(analistasCount), 
        backgroundColor: '#0ea5e9', 
        borderRadius: 6, 
        barThickness: 20 
      }]
    },
    options: { 
      indexAxis: 'y', 
      responsive: true, 
      maintainAspectRatio: false, 
      plugins: { 
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context) => `${context.parsed.x} projeto(s)`
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });

  // Gr√°fico de Status - COM CORES PERSONALIZADAS
  const statusLabels = Object.keys(statusCount);
  const statusColors = statusLabels.map(status => getStatusColor(status));
  
  charts.status = new Chart(document.getElementById('status'), {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{ 
        data: Object.values(statusCount), 
        backgroundColor: statusColors,
        borderWidth: 0,
        hoverOffset: 10
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false, 
      cutout: '70%', 
      plugins: { 
        legend: { 
          position: 'bottom',
          labels: {
            padding: 15,
            usePointStyle: true,
            font: { size: 11, weight: '600' }
          }
        },
        tooltip: {
          callbacks: {
            label: (context) => `${context.label}: ${context.parsed} projeto(s)`
          }
        }
      } 
    }
  });

  // Curva S
  const mediaGeral = p.length > 0 
    ? Math.round(p.reduce((acc, curr) => acc + (curr.Total > 0 ? (curr.Concluidas/curr.Total)*100 : 0), 0) / p.length) 
    : 0;
    
  charts.curve = new Chart(document.getElementById('curve'), {
    type: 'line',
    data: {
      labels: ['In√≠cio', 'Progresso Atual'],
      datasets: [
        { 
          label: 'Meta Planejada', 
          data: [0, 100], 
          borderColor: '#94a3b8', 
          borderDash: [5, 5], 
          borderWidth: 2, 
          fill: false, 
          tension: 0.4,
          pointRadius: 4
        },
        { 
          label: 'Realizado', 
          data: [0, mediaGeral], 
          borderColor: '#10b981', 
          backgroundColor: 'rgba(16, 185, 129, 0.1)', 
          fill: true, 
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7
        }
      ]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            usePointStyle: true,
            font: { size: 11, weight: '600' }
          }
        },
        tooltip: {
          callbacks: {
            label: (context) => `${context.dataset.label}: ${context.parsed.y}%`
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: true, 
          max: 100,
          ticks: {
            callback: (value) => value + '%'
          }
        } 
      } 
    }
  });
}

// ========== MODAL ==========
function openModal(title, obs){
  document.getElementById("mTitle").textContent = title;
  document.getElementById("mObs").textContent = obs;
  document.getElementById("modal").style.display = "flex";
}

function closeModal(){ 
  document.getElementById("modal").style.display = "none"; 
}

window.onclick = e => { 
  if(e.target == document.getElementById("modal")) closeModal(); 
}

// ========== INICIALIZA√á√ÉO ==========
window.onload = fetchData;

// Auto-atualiza√ß√£o a cada 5 minutos
setInterval(fetchData, 300000);
</script>
</body>
</html>